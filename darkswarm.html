<!DOCTYPE html>
<html>


<!-- Head section is for stuff that is not going to be on the page -->
<head>
	<meta charset="utf-8" />
	<title>Gunnar Portfolio</title>
	<link rel="stylesheet" href="styles/main.css">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&icon_names=description,groups,link,list,manufacturing" />
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	<!-- Favicon -->
	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
	<link rel="manifest" href="/site.webmanifest">
	<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
	<meta name="msapplication-TileColor" content="#00aba9">
	<meta name="theme-color" content="#ffffff">
</head>

<!-- Body is for everything on the page -->
<body>
	<!-- Sticky Header with socials-->
	<div class="sticky-header">
		<a class="sticky-header-button" href="mailto: gunnarmagnum@gmail.com">gunnarmagnum@gmail.com</a>
		<a class="sticky-header-button" href="https://github.com/Raestkjoot" target="_blank">
			<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-github" viewBox="0 0 16 16"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.01 8.01 0 0 0 16 8c0-4.42-3.58-8-8-8"/></svg>
		</a>
		<a class="sticky-header-button" href="https://www.linkedin.com/in/gunnar-magnussen/" target="_blank">
			<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-linkedin" viewBox="0 0 16 16"><path d="M0 1.146C0 .513.526 0 1.175 0h13.65C15.474 0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487 0 14.854zm4.943 12.248V6.169H2.542v7.225zm-1.2-8.212c.837 0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248S2.4 3.226 2.4 3.934c0 .694.521 1.248 1.327 1.248zm4.908 8.212V9.359c0-.216.016-.432.08-.586.173-.431.568-.878 1.232-.878.869 0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.274 0-1.845.7-2.165 1.193v.025h-.016l.016-.025V6.169h-2.4c.03.678 0 7.225 0 7.225z"/></svg>
		</a>
	</div>

	<!-- Header with navigation -->
	<header>
		<div>
			<h1>Gunnar Magnussen</h1>
			<p class="sub-title"><b>Gameplay Programmer</b> | Game feel, physics, graphics and systems</p>
		</div>
		<div class="nav">
			<a class="header-button" href="index.html"> Projects </a>
			<a class="header-button" href="exp-and-edu.html"> Experience & Education </a>
			<a class="header-button" href="about-me.html"> About Me </a>
		</div>
	</header>

	<!-- TEXT -->
	 <div class="outer-text-container">
	<div class="text-container">
		<h1>DarkSwarm</h1>
		<div class="project-overview">
			<div class="project-overview-elem">
				<iframe width="560" height="315" src="https://www.youtube.com/embed/smRHsBm5_F4?si=-ow2-7KfXmJ3kDMe" title="YouTube video player" frameborder="0" 
					allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
					referrerpolicy="strict-origin-when-cross-origin" allowfullscreen>
				</iframe>
			</div>
			<div class="project-overview-elem">
				<i>
					<span class="material-symbols-outlined">manufacturing</span>
					&nbsp;<b>Engine:</b>&nbsp; Unreal
				</i>
				<i>
					<span class="material-symbols-outlined">description</span>
					&nbsp;<b>Language:</b>&nbsp; C++ & Blueprint
				</i>
				<i>
					<span class="material-symbols-outlined">list</span>
					&nbsp;<b>Tasks:</b>&nbsp; Aiming | Weapon System | Multiplayer
				</i>
				<i>
					<span class="material-symbols-outlined">groups</span>
					&nbsp;<b>Team Size:</b>&nbsp; ~15
				</i>
				<i>
					<span class="material-symbols-outlined">link</span>
					&nbsp;<b>Links:</b>&nbsp; <a class="links-button" href="https://store.steampowered.com/app/2303200/DarkSwarm/" target="_blank">Steam Page</a>
					| <a class="links-button" href="https://darkswarm.com/" target="_blank">Game Website</a>
					| <a class="links-button" href="https://www.youtube.com/watch?v=yWFzBAguvVA" target="_blank">Trailer</a>
				</i>
				<i>
					My task at Bitfire was to rework the existing aiming and weapon system to allow for all their future weapon plans, get the aiming to feel just right in every situation, and optimize it to work with more enemies.
					The aiming system had to take 2D input and translate it to a target in 3D space, which felt right to the player.
					The weapon system is highly modular, is replicated in a client-server architecture, and uses Unreal's Gameplay Ability System for abilities and interactions.
				</i>
			</div>
		</div>

		Everything shared here is done so with express permission from BitFire Games.

		<hr />

		<!-- AIMING -->
		<h2>
			Aiming
		</h2>
		<p>
			The aiming system in DarkSwarm takes a 2D input direction and translates it into a 3D aim direction.
			Classical twin-stick shooters directly map input to aim direction. DarkSwarm, however, has a completely 3D environment, 
			and I was tasked with making the aiming system work in 3 dimensions in a way that would feel intuitive and fun to players.
		</p>
		<p>
			The solution requires thinking in two different coordinate systems: that of the 3D world, and that of the player's 2D window into the world.
			A direction that looks like it might hit a target from one perspective might completely miss from another perspective, since the y-axis of the window represents both the y and the z-axis of the game world.
		</p>
		<div class="project-image-container">
			<img src="images/darkswarm-topdown.jpg" class="project-image"/>
			<img src="images/darkswarm-topdown-rotated.jpg" class="project-image"/>
		</div>
		<p>
			To transform the 2D input direction to a higher dimension, we construct a 3D aim plane based on the player's input and view direction.
			Within this plane we can aim at any point and it will look like the same direction from the player's perspective.
		</p>
		<img src="images/darkswarm-aimplane.png" class="project-image"/>
		<p>
			This aim plane is used to find potential targets and then finally output a 3D aim direction.
		</p>
		<img src="images/darkswarm-aim-input-output.png" class="project-image" style="height: 400px"/>
		<p>
			To find potential targets, we do a capsule sweep in the direction and orientation of the aim plane.
		</p>
		<!-- CODE EXAMPLE: Find potential targets -->
		<div class="code"><pre style="margin: 0; line-height: 125%; tab-size: 4;">
<span style="color: #ae81ff">void</span> <span style="color: #66d9ef">UDS_AimingComponent</span>::<span style="color: #66d9ef">FindPotentialTargets</span>(<span style="color: #66d9ef">TArray</span><<span style="color: #66d9ef">FHitResult</span>>& OutTargets)
{
	<span style="color: #66d9ef">FCollisionQueryParams</span> Params;
	Params.bIgnoreBlocks = <span style="color: #ffbe21">true</span>;
	Params.bTraceComplex = <span style="color: #ffbe21">false</span>;

	<span style="color: #66d9ef">FVector</span> TraceEnd = AimOriginLocation + InputDirection * MaxAimDistance;
	<span style="color: #66d9ef">FQuat</span> TraceCapsuleOrientation = <span style="color: #66d9ef">CameraDirection</span>.<span style="color: #66d9ef">ToOrientationQuat</span>().<span style="color: #66d9ef">GetUpVector</span>().<span style="color: #66d9ef">ToOrientationQuat</span>();

	<span style="color: #66d9ef">GetWorld</span>()-><span style="color: #66d9ef">SweepMultiByObjectType</span>(
		OutTargets, 
		AimOriginLocation, TraceEnd, 
		TraceCapsuleOrientation, TargetsObjectParams, CollisionShape, Params);
}
		</pre></div>
		<p>
			To find the location on the target's collision capsule that the system should aim towards, we think about the first and last point the aim plane will intersect as the player aims across the target.
		</p>
		<img src="images/darkswarm-aimplane-intersection.png" class="project-image"/>
		<!-- CODE EXAMPLE: Find aim location on target capsule -->
		<div class="code"><pre style="margin: 0; line-height: 125%; tab-size: 4;">
<span style="color: #66d9ef">FVector</span> <span style="color: #66d9ef">UDS_AimingComponent</span>::<span style="color: #66d9ef">FindAimLocationOnTargetCapsule</span>(<span style="color: #ae81ff">const</span> <span style="color: #66d9ef">FHitResult</span>& Target)
{
	<span style="color: #75715e">// find bottom and top half-height of cylinder</span>
	<span style="color: #66d9ef">UCapsuleComponent</span>* EnemyCapsule = Target.<span style="color: #66d9ef">GetActor</span>()-><span style="color: #66d9ef">GetComponentByClass</span><<span style="color: #66d9ef">UCapsuleComponent</span>>();
	<span style="color: #66d9ef">FVector</span> TargetCenter = Target.<span style="color: #66d9ef">GetActor</span>()-><span style="color: #66d9ef">GetActorLocation</span>();
	<span style="color: #ae81ff">float</span> CylinderHalfHeight = EnemyCapsule-><span style="color: #66d9ef">GetScaledCapsuleHalfHeight</span>() - EnemyCapsule-><span style="color: #66d9ef">GetScaledCapsuleRadius</span>();
	<span style="color: #66d9ef">FVector</span> CapsuleEndA = TargetCenter + <span style="color: #66d9ef">FVector</span>::UpVector * CylinderHalfHeight;
	<span style="color: #66d9ef">FVector</span> CapsuleEndB = TargetCenter - <span style="color: #66d9ef">FVector</span>::UpVector * CylinderHalfHeight;

	<span style="color: #75715e">// Add radius in the direction of the aim plane normal</span>
	<span style="color: #66d9ef">FVector</span> AimPlaneUpVector = <span style="color: #66d9ef">FVector</span>::<span style="color: #66d9ef">CrossProduct</span>(InputDirection, CameraDirection).<span style="color: #66d9ef">GetSafeNormal</span>();
	<span style="color: #66d9ef">FVector</span> RadDir = AimPlaneUpVector * EnemyCapsule-><span style="color: #66d9ef">GetScaledCapsuleRadius</span>();

	<span style="color: #ae81ff">if</span> (RadDir.Z > <span style="color: #ffbe21">0.0f</span>)
	{
		CapsuleEndA += RadDir;
		CapsuleEndB -= RadDir;
	}
	<span style="color: #ae81ff">else</span>
	{
		CapsuleEndA -= RadDir;
		CapsuleEndB += RadDir;
	}

	<span style="color: #75715e">// Find the endpoints A-B vector's intersection point with the aim plane</span>
	<span style="color: #66d9ef">FVector</span> CapsuleAimRay = CapsuleEndB - CapsuleEndA;

	<span style="color: #ae81ff">return</span> <span style="color: #66d9ef">FMath</span>::<span style="color: #66d9ef">RayPlaneIntersection</span>(CapsuleEndA, CapsuleAimRay, <span style="color: #66d9ef">FPlane</span>(AimOriginLocation, AimPlaneUpVector));
}
		</pre></div>


		<p>
			There are many more functions to account for different input types, line of sight, prioritizing targets, etc.
			Getting to the solution that felt just right to players was an iterative process involving multiple playtests with the team, constant dialogue with designers and animators, and working in a testbed level I created to test and iron out all edge cases.
		</p>

		<hr />

		<!-- WEAPON SYSTEM -->
		<h2>
			Weapon System
		</h2>
		<p>
			The weapon system is built to be modular. For example, projectiles can be easily swapped out and different components such as scopes and flashlights can be added to different weapons.
			Using Unreal's Data Assets, the weapon stats are easy for the designers to tweak. Some parts are inspired by Unreal's Lyra project, but tailored to DarkSwarm's specific needs.
		</p>
		<p>
			Using Unreal's Gameplay Ability System (GAS), allows us to create complex interactions. For example, weapon fire can be blocked by tags such as 'Downed' or 'Trapped'.
			GAS also lets each weapon behave in completely unique ways, by granting the player a different set of abilities.
		</p>
		<p>
			I build an inventory component for the player character to handle what weapons are currently equipped. The inventory uses an asset manager to make sure we only load the necessary weapons.
		</p>
		<p>
			To design this system I set up and held meetings with the rest of the tech team and was in dialogue with the designers about what they wanted and how to best accomodate their workflows. 
		</p>
		<img src="images/darkswarm-weapon-system-uml.png" class="project-image" style="height: 480px"/>
		<hr />

		<!-- MULTIPLAYER -->
		<h2>
			Multiplayer
		</h2>
		<p>
			DarkSwarm is a co-op focused game and uses a client-server networking architecture. 
			The server is authoritative, so important events are sent to the server, that then replicates valid events to all clients.
		</p>
		<img src="images/darkswarm-shoot-multiplayer-sequence.png" class="project-image" style="height: 280px"/>
		<p>
			This means that the server is always ahead of the clients. To make the game feel responsive to players on client machines, we have to predict the outcome.
			This is mostly handled by GAS, but things such as spawning projectiles would require custom prediction logic.
		</p>
		<p>
			Everything I worked on had to work in a multiplayer setting: The aim system replicates the aim direction, and the weapon system replicates what weapon is equipped and the attacks with those weapons.
		</p>

		<!-- CODE EXAMPLE: RPC functions -->
		<div class="code"><pre style="margin: 0; line-height: 125%; tab-size: 4;">
<span style="color: #75715e">// RPC functions in a weapon system header file</span>
<span style="color: #ae81ff">public</span>:
	<span style="color: #66d9ef">UFUNCTION</span>(Server, Reliable)
	<span style="color: #ae81ff">void</span> Server_BeginAttack();
	<span style="color: #66d9ef">UFUNCTION</span>(NetMulticast, Reliable)
	<span style="color: #ae81ff">void</span> NetMulti_BeginAttack();
	</pre></div>

	<!-- CODE EXAMPLE: Replicated properties -->
<div class="code"><pre style="margin: 0; line-height: 125%; tab-size: 4;">
<span style="color: #75715e">// Replicated properties setup in the aiming system</span>
<span style="color: #ae81ff">void</span> <span style="color: #66d9ef">UDS_AimingComponent</span>::<span style="color: #66d9ef">GetLifetimeReplicatedProps</span>(<span style="color: #66d9ef">TArray</span><<span style="color: #66d9ef">FLifetimeProperty</span>>& OutLifetimeProps) <span style="color: #ae81ff">const</span>
{
	<span style="color: #ae81ff">Super</span>::<span style="color: #66d9ef">GetLifetimeReplicatedProps</span>(OutLifetimeProps);

	<span style="color: #66d9ef">DOREPLIFETIME</span>(<span style="color: #66d9ef">UDS_AimingComponent</span>, AimLocation);
	<span style="color: #66d9ef">DOREPLIFETIME</span>(<span style="color: #66d9ef">UDS_AimingComponent</span>, AimOriginLocation);
}
</pre></div>
	</div>
</div>

</body>
</html>